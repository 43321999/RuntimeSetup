<span align="center">
  
  # [wireguard](https://ubuntu.com/server/docs/wireguard-vpn-introduction)

  ## Dockerfile
  ```sh
  FROM ubuntu

RUN \
echo "**** install dependencies ****" && \
apt-get update && \
apt-get install -y --no-install-recommends \
iproute2 && \
echo "**** install wireguard-tools ****" && \
apt-get install -y --no-install-recommends \
wireguard-tools && \
echo "**** clean up ****" && \
rm -rf \
  /tmp/* \
  /var/lib/apt/lists/* \
  /var/tmp/*
  ```
  
 ```docker build -t wireguard ~/apps/wireguard```
  
</span>

## keygen
### Dockerfile.keygen
```yaml
FROM ubuntu

RUN \
echo "**** install wireguard-tools ****" && \
apt-get update && \
apt-get install -y --no-install-recommends \
wireguard && \
echo "**** clean up ****" && \
rm -rf \
  /tmp/* \
  /var/lib/apt/lists/* \
  /var/tmp/* 

ENTRYPOINT \
umask 077 \
wg genkey | tee private.key | wg pubkey > public.key
```

```docker build -f Dockerfile.keygen -t wireguard:keys ~/apps/wireguard```

```sh
docker run --rm \
-v ~/apps/wireguard:/etc/wireguard/ \
-w /etc/wireguard/ \
--cap-add=NET_ADMIN \
--cap-add=SYS_MODULE \
-v /lib/modules:/lib/modules \
wireguard:keys
```

```sh
#
# rename keys and repeate docker run
#
mv private.key site-private.key
mv public.key site-public.key
#
docker run ...
docker image rm wireguard:keys
```

```vi ~/apps/wireguard/00.conf```
```txt
[Interface]
PrivateKey = <site-private.key>
ListenPort = 1025
Address = fc00::/7

[Peer]
PublicKey = <peer-public.key>
AllowedIPs = fc1b::/128
Endpoint = 43.207.172.176:1025
PersistentKeepalive = 25
```

```vi ~/apps/wireguard/1b.conf```
```txt
[Interface]
PrivateKey = <peer-private.key>
ListenPort = 1025
Address = fc1b::/128
SaveConfig = true

[Peer]
PublicKey = <site-public.key>
AllowedIPs = fc00::/7
```


## 00 runtime:

### Dockerfile

```yaml
FROM ubuntu

RUN \
echo "**** install dependencies ****" && \
apt-get update && \
apt-get install -y --no-install-recommends \
iproute2 && \
echo "**** install wireguard-tools ****" && \
apt-get install -y --no-install-recommends \
wireguard && \
echo "**** clean up ****" && \
rm -rf \
  /tmp/* \
  /var/lib/apt/lists/* \
  /var/tmp/*

COPY 00.conf /etc/wireguard/

CMD \
ip link del 00 && \
wg-quick up 00 && \
sleep infinity & wait $! ||\
\
wg-quick up 00 && \
sleep infinity & wait $!
```

```sh
cd apps/wireguard
docker build -t wireguard:00 ~/apps/wireguard/
```

>```sh
>docker run -d \
>--network host \
>--name=wireguard.00 \
>--cap-add=NET_ADMIN \
>--cap-add=SYS_MODULE \
>-v /lib/modules:/lib/modules \
>--restart unless-stopped \
>wireguard:00
>```
  
<span align="right">
  
  local container:
```sh
  ###
```
</span>


<span align="right">
  
  ```sh
  #
  #
  #
  ```
</span>


## 1b runtime:

### Dockerfile
```yaml
FROM ubuntu

RUN \
echo "**** install dependencies ****" && \
apt-get update && \
apt-get install -y --no-install-recommends \
iproute2 && \
echo "**** install wireguard-tools ****" && \
apt-get install -y --no-install-recommends \
wireguard && \
echo "**** clean up ****" && \
rm -rf \
  /tmp/* \
  /var/lib/apt/lists/* \
  /var/tmp/*

COPY 1b.conf /etc/wireguard/

CMD \
ip link del 1b && \
wg-quick up 1b && \
sleep infinity & wait $! ||\
\
wg-quick up 1b && \
sleep infinity & wait $!
```

```
cd apps/wireguard/
docker build -t wireguard:1b ~/apps/wireguard/
```

>```sh
>docker run -d \
>--network host \
>--name=wireguard.1b \
>--cap-add=NET_ADMIN \
>--cap-add=SYS_MODULE \
>-v /lib/modules:/lib/modules \
>--restart unless-stopped \
>wireguard:1b \
>```

<span align="right">
  
  remote container:
```sh
  #
  #
  #
```
</span>

#### debug
```sh
docker run -d \
--network host \
--name=wireguard.1b \
--cap-add=NET_ADMIN \
--cap-add=SYS_MODULE \
-v /lib/modules:/lib/modules \
-v ~/apps/wireguard:/etc/wireguard/ \
--restart unless-stopped \
wireguard:1b
```
